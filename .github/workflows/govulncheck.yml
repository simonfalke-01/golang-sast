name: Run govulncheck

on:
  pull_request:
    branches: ["main"]
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  security-events: write

jobs:
  govulncheck:
    name: Go Vulnerability Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"
          cache: true

      - name: Download dependencies
        run: go mod download

      - name: Run govulncheck
        uses: golang/govulncheck-action@v1
        with:
          go-version-input: 1.24.5
          go-package: ./...
          repo-checkout: false

      - name: Run govulncheck with JSON output
        run: |
          go install golang.org/x/vuln/cmd/govulncheck@latest
          govulncheck -json ./... > govulncheck-results.json
        continue-on-error: true

      - name: Upload govulncheck results
        uses: actions/upload-artifact@v4
        with:
          name: govulncheck-results
          path: govulncheck-results.json
        if: always()

      - name: Display results summary
        run: |
          if [ -f govulncheck-results.json ]; then
            echo "Govulncheck completed. Check artifacts for detailed results."
            # Display a simple summary
            govulncheck ./... || true
          fi
